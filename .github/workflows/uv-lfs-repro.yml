name: Reproduce uv Git-LFS Lock Bug

on:
  workflow_dispatch:

jobs:
  reproduce:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show git version
        run: git --version

      # -------------------------
      # Step 1: Install uv 0.9.7
      # -------------------------
      - name: Install uv 0.9.7
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | \
            UV_INSTALL_VERSION=0.9.7 sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          uv --version

      # --------------------------------------------
      # Step 2: Produce lock file using 0.9.14 + LFS
      # --------------------------------------------
      - name: Create lock file using uv 0.9.14
        env:
          UV_GIT_LFS: 1
        run: |
          uv lock --no-sources
          echo "=== uv.lock generated by uv 0.9.14 ==="
          cat uv.lock

      # Optional: Upload the lock file
      - name: Upload lockfile artifact
        uses: actions/upload-artifact@v4
        with:
          name: uv-lock-from-0.9.7
          path: uv.lock

      # -------------------------
      # Step 3: Install uv 0.9.16
      # -------------------------
      - name: Install uv 0.9.16
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | \
            UV_INSTALL_VERSION=0.9.16 sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          uv --version

      # -------------------------------------------------
      # Step 4: Test the lock file using uv 0.9.16 (FAILS)
      # -------------------------------------------------
      - name: Validate lock file using uv 0.9.16
        env:
          UV_GIT_LFS: 1
        run: |
          echo "Running uv lock --check --no-cache --no-sources"
          uv lock --check --no-cache --no-sources

